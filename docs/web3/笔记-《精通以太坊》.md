# 《精通以太坊》读书笔记



##### 不懂的概念放这



共识规则：独立验证交易和发行货币的一套规则

难度炸弹

契约

椭圆曲线数字签名算法（ECDSA）

EIP（以太坊改进建议，可见于以太坊的Github仓库：https://github.com/ethereum/EIPS）

ENS（以太坊命名服务，同样可见于以太坊的Github仓库）

ERC（以太坊注释请求）

图灵完备、图灵机（以太坊的编程语言是图灵完备的，以太坊虚拟机是一台通用图灵机）

状态机

去中心化自治组织：DAO

Keccak256（以太坊使用的Hash算法）

挖矿与矿工

孤儿区块、ommer区块

以太坊的实质：确定性但实际上无界的状态机？

gossip协议

以太坊客户端、以太坊协议



#### 概念

**账户**

账户由以下部分组成：

* 地址

* 余额

* 随机数

* 可选的存储或编程的对象

账户有两种类型：

* 合约账户：包含代码的账户，当收到转账时便会自动执行代码
* 外部拥有账户（EOA）：由真人用户创建的账户



**钱包**

钱包不负责保存虚拟币，只负责生成、保存密钥。

钱包中的每个密钥，都由随机数独立生成，密钥间彼此无关，这种属于非确定性钱包（JBOK钱包）；

钱包中的每个密钥，都由一个主密钥（seed）派生出来，这种属于确定性钱包（HD钱包）；一般主密钥又会被编码为“助记词”。

现在JBOK钱包已不被推荐使用。





**数字签名**

用户可以通过私钥对任何文档生成称为“签名”的短字符串数据。作用：

* 表明自己是该文件的所有者（只有自己的公钥能解密）
* 签署后，可以防止文件被修改

在以太坊中，则需要对存储在分布式以太坊网络中、属于自己的“以太币”进行数字签名，表明这些“以太币”属于自己，才能花费这些“以太币”。



**以太坊虚拟机EVM**

跟JVM（Java虚拟机）类似，是一个执行字节码的虚拟机。

EVM汇编语言：字节码的可读形式；

Solidity：高级语言



**Gas燃气**

以太坊用于执行智能合约的虚拟燃料。

智能合约中的每条指令，都需要计算机执行；

这个智能合约需要耗费多少计算资源，由燃气来作为衡量单位；



**KeyStore文件**

Json格式的文件，包含一个私钥，并被一个密码加密。



**以太坊不同的开发阶段**

| 区块号     | 阶段/硬分叉     | 代号                                   | 持续年份         | 描述 |
| ---------- | --------------- | -------------------------------------- | ---------------- | ---- |
| #0         | 第一阶段        | 前沿（Frontier）                       | 2015.7.30~2016.3 |      |
| #200,000   | 硬分叉          | 冰河时期（Ice Age）                    |                  |      |
| #1,150,000 | 第二阶段        | 家园（Homestead）                      | 2016.3~2017.10   |      |
| #1,192,000 | 硬分叉          | DAO                                    |                  |      |
| #2,463,000 | 硬分叉          | 蜜桔前哨（Tangerine Whistle）          |                  |      |
| #2,675,000 | 硬分叉          | 假龙（Spurious Dragon）                |                  |      |
| #4,370,000 | 第三阶段&硬分叉 | 大都会：拜占庭（Metropolis Byzantium） | 2017.10~         |      |
| 未知       | 硬分叉          | 大都会：君士坦丁堡（Constantinople）   |                  |      |
| 未知       | 第四阶段        | 宁静（Serenity）                       |                  |      |





**Mist（以太坊浏览器）**



**Swarm、Web3、Whisper**

Dapp构建的三大组件。

* Swarm：提供一种去中心化的存储网络
* Web3：基于去中心化协议的应用程序
* Whisper：提供一种去中心化的消息系统



**测试网Testnet**

相当于测试环境中运行的以太坊，用于模拟以太网主要网络的行为。

测试网上的以太币无价值，只可以在测试环境使用。

主要有：

* Ropsten（公共测试网，PoW，工作证明共识）
* Kovan（公共测试网，PoA，权威证明共识，只有Parity客户端可用）
* Rinkeby（公共测试网，PoA，权威证明共识，只有Geth客户端可用）
* Ganache（本地测试网，还提供了一个Ganache CLI作为命令行工具）

如何在测试网上获得以太币？

​	每天都可以通过水龙头（faucet）获取到测试代币。

​	需要通过以太坊客户端（Geth或Parity），或者轻量级客户端（MetaMask等）连接到测试网络。

​	流程如下（以MetaMask为例）：

* 在metamask上，将网络切换到测试网络；
* 点击buy，然后点击“ropsten test faucet”，进入一个新页面，然后点击“request 1 ether from faucet”
* faucet应用程序创建一个交易，交易成功后会返回一个交易ID，1ether会进入到你的测试地址
* 可以在etherscan.io上根据交易ID查询到这边交易的详情

如何在测试网上花费以太币？

* 同样在metamask的测试网络上操作，操作略。
* 需要注意的是，交易需要支付gas费给矿工，因此若你只有1ether，你完成交易可能需要1.000063eth，其中的0.000063eth就是gas费







**以太坊网络**

包括：

* Ethereum（主网络）
* Ethereum Classic
* Ella
* Expanse
* Ubiq
* Musicoin
* ...



**以太坊客户端**

以太坊客户端，是一个应用程序，是以太坊协议的实现。

当你的电脑启动了以太坊客户端，你的电脑就成为以太坊网络中的一个节点（也就是矿工），并且与其他节点一起存储**所有的**区块信息，打包交易等等；至于连接到哪个网络，由你选择。

轻量级以太坊客户端，例如MetaMask、Emerald Wallet、MyCrypto等。这些客户端提供钱包的功能，并可以切换到不同网络；同时，它们不负责存储区块信息、打包交易。







**Tuffle**

以太坊开发框架，包含一些NodeJs包。



**零地址**

一个特殊的以太坊地址，全部由0组成；

当想创建一个智能合约时，需要发起一个指向零地址的交易。



**状态机**



**共识算法**

共识算法是什么？

​	在区块链系统中，许多节点参与到记账、打包区块的工作中，那么谁打包的区块最终能记录到链上，这就是共识算法解决的问题。

​	而在其他的分布式系统中（比如Eureka集群、Mysql集群、MQ集群等等），由多个节点负责处理外部进来的请求。如何选出合适的一个节点去处理请求，这也是共识算法解决的问题。



有哪些共识算法？

​	工作量证明算法（PoW）、权益证明算法（PoS）、股份授权证明算法（DPoS）、权威证明算法（PoA）



共识算法各自的优缺点

| 算法                     | 描述 | 优点 | 缺点 |
| ------------------------ | ---- | ---- | ---- |
| 工作量证明算法（PoW）    |      |      |      |
| 权益证明算法（PoS）      |      |      |      |
| 股份授权证明算法（DPoS） |      |      |      |
| 权威证明算法（PoA）      |      |      |      |



**Infura**

以太坊网络的API提供商，提供：

* RPC API
* REST API
* IPFS API
* Websockets API





#### FAQ

**以太币的发行规则？总量是多少？**

以太币的发行主要包括前期的预售和后期的挖矿产生。

预售：

| 数量                         | 发行方式 | 描述                                                        |
| ---------------------------- | -------- | ----------------------------------------------------------- |
| 6千多万枚                    | 预售     | 2014年7月24日，以太坊启动了为期42天的众筹，一共售出的以太币 |
| 预售的9.9%                   | 分配     | 以太坊早期的开发者                                          |
| 预售的9.9%                   | 分配     | 以太坊长期的研究项目                                        |
| 72002454.768枚（7千2百多万） |          | 预售+分配的总数                                             |

挖矿：

以太坊节点（又被称为矿工）每成功打包一个新的区块，都能获得以太币（又被称为Gas燃气费）

不同时期的出块奖励又不一样，奖励机制可以被调整：

| 时期                               | 奖励机制  |
| ---------------------------------- | --------- |
| 前期                               | 5枚以太币 |
| 第三阶段：拜占庭时期（2017年10月） | 3枚以太币 |
| 第三阶段：君士坦丁堡               | 2枚以太币 |

不同于比特币的总量恒定，以太币没有供应上限。

 

**以太币存储在哪里？如何用于交易？**

存储在哪里：

以太币存储在一个EOA账户（外部所有账户）中；

EOA账户含有一个以太坊地址来接收以太币（以太坊地址可以理解为“银行卡号”）；

需要使用私钥，才能操作EOA账户上面的以太币（私钥可以理解为“银行卡密码”）；



如何交易：

以太币的实质是UTXO，即Unspent Transacation Output（未花费的交易输出）。

UTXO是一条记录，可被以太坊网络中的所有节点保存且查询，但只有拥有对应密钥的账户才能使用。

钱包应用会自动查询并保存以太坊上有你地址的UTXO，来计算你的余额。

每一笔交易都有输入和输出，输入是你拥有的部分或全部UTXO，输出是新的UTXO。注意，输出可以有多条。

示例1：比如，有一笔5ETH的交易，接收人是你的地址。当这笔交易被打包到链上，就会产生一条UTXO记录，并广播到以太坊网络中；当每个节点都接收到这条UTXO，那么大家就认为你获得了5ETH，这条UTXO就等于值5ETH的“钞票”。

示例2：当你想花2ETH时，钱包会将你5ETH的UTXO作为输入，同时会生成两条UTXO：

* ”发送2ETH给对方“的UTXO，用于支付。
* ”发送3ETH给你“的新的UTXO，相当于”找零“。





**以太坊的交易原理是怎样的？**

1. 创建交易账号，获得私钥和钱包地址

   创建原理：随机数 -> 私钥 -> 公钥 -> 钱包地址

   * 随机数：从操作系统底层的一个密码学安全的随机源获得，256位。
   * 私钥：通过SHA256、Base58，将随机数转换成易书写和识别的数字，50位
   * 公钥：由私钥和Secp256k1（椭圆曲线算法）生成，65位
   * 地址：
     * 地址的主体：对公钥进行SHA256和RIPEMD160双哈希运算，对结果再进行Hash160运算，获得20字节长的摘要结果；
     * 地址校验码：对主体进行两次SHA256运算，取前4位
     * 版本前缀：0x00
     * 完整的地址 = （ 版本前缀 + 主体信息 + 校验码 ） 通过Base58处理生成

2. 发起交易

   假设之前有朋友通过一笔交易，转了1ETH给我。现在我想花费0.1ETH。流程如下：

   1. 生成交易报文：

      UTXO的格式大致如下：

      ```json
      {
          "发送人"："朋友",
          "接收人"："A",
          "交易来源"："某一次交易的Hash值",
          "发送面额"："1ETH"
      }
      ```

      

      交易发起人生成的交易报文大致如下：

   ```json
   //交易的输入：朋友发起交易给我所产生的UTXO
   "vin":[
       {
           "txid":"61230ga02kqi23o941k92", //交易ID，标识来自哪个交易的UTXO将被引用
           "vout":0, //引用该交易的第1个UTXO（第一个的下标为0）
           "scriptSig" : "304501231245123dq13", //该UTXO的解锁脚本，满足该脚本才能使用该UTXO
           "sequence" : 4102945125 //序列号
       }
   ]
   
   "vout":[
       //交易的输出1：这是用于花费的UTXO
       {
         "发送人"："A",
         "接收人"："B",
         "交易来源"："上一次交易的Hash值",
         "发送面额"："0.1ETH"
       }
       //交易的输出2：这相当于找零用的UTXO
       {
         "发送人"："A",
         "接收人"："A",
         "交易来源"："上一次交易的Hash值",
         "发送面额"："0.899ETH"
       }
       //交易的输出3：加密难题（也被称为locking script、witness script、矿工费）
       {
         "发送人"："A",
         "接收人"："报酬地址（保留给矿工自己设置）",
         "交易来源"："上一次交易的Hash值",
         "发送面额"："0.001ETH"
       }
   ]
   
   ```

   2. 数字签名：交易发起人先通过Hash算法对生成报文的摘要，然后使用自己的私钥，将摘要加密，得到加密报文（即数字签名）；使用的加密算法是椭圆曲线数字签名算法（ECDSA）；

   3. 发出交易：交易发起人将原文+密文+公钥，广播到区块链网络；

3. 验证交易的真实性

   节点从以太坊网络中收到交易，通过Hash算法生成原文的摘要1；

   用公钥对密文解密，还原出摘要2；

   若两个摘要相同，则通过验证，报文没被篡改；

   同样，使用的解密算法是椭圆曲线数字签名算法（ECDSA）；

4. 记账

   验证通过，则由区块链节点（又称为矿工、客户端）将交易记到分布式账本中。

   记账成功的区块链节点可获得以太币奖励。

5. 打包

   每隔10分钟，将所有新的交易打包（也称为挖矿），并作为区块链中的新区块。

   打包成功的区块链节点可获得以太币奖励。

   > 区块体的结构：
   >
   > * 区块头
   >   * 默克尔树的根（Root）
   >   * 上一个区块的哈希（上一个区块的默克尔树的区块头的哈希值）
   >   * 高度
   >   * 随机数（nonce）
   >   * 其他信息
   > * 区块体
   >   * 默克尔树（其叶子节点就是交易，中间节点是对子节点求哈希得出）
   >
   > 区块体的特征：
   >
   > * 交易不易被篡改：篡改区块中的交易，就等于修改区块中默克尔树的叶子节点；当叶子节点内容被修改，默克尔树的根的值也会变的不一致。
   > * 随机数的作用：许多节点会一起对交易进行记账打包，那么以谁的为准呢？设计者设计了一个比赛，那就是解一个数学难题。具体就是节点需要尝试不同的随机数，使当前区块头的哈希值满足某个特性，比如哈希值的前32位为0。这个比赛也称为“工作量证明”。



**有哪些常用的哈希算法？哈希算法在以太坊中的作用？**

* Keccak256（以太坊使用的Hash算法）
* SHA（安全哈希算法，美国国家标准与技术研究院NIST发布的一系列加密哈希算法）





**有哪些智能合约开发的高级语言？**

* Solidity（语法类似于Java、Javascript，面向对象式编程语言）
* Serpent（语法类似于Python，过程式编程语言）
* Vyper（类似于Serpent）



**如何与以太坊客户端交互？有哪些编程的底层依赖包**

* Javascript：Tuffle
* Go：Geth
* Rust：parity
* C++：cpp-ethereum
* Python：pyethereum
* Scala：mantis
* Java：harmony

以太坊客户端一般会暴露一些RPC接口（又称为JSON-RPC-API），开发者可以通过这些接口获取到以太坊当前的一些基本情况。例如：

当前Gas费用、客户端的版本等等。



**以太坊的技术架构？由哪些组件组成？**

技术分层：

* 数据层：实现数据的存储
* 网络层：实现网络节点的连接和通信
* 共识层：实现数据一致性
* 激励层：实现以太币的发行和分配机制
* 智能合约层



基本由以下部分组成，详细情况可参考以太坊黄皮书（到Github上）：

* P2P网络（P2P Network）
  * 一个连接参与者、可以传播交易、包含了已验证交易的区块、基于gossip协议的网络
  * gossip是应用层协议
* 共识规则（Consensus rules）
* 消息、交易（Transaction）
  * 请求报文、交易报文
* 状态机（State Machine）
  * 由EVM（以太坊虚拟机）作为实现
* 分布式数据库（Blockchain）
  * 通常以Google的LevelDB作为实现
* 共识算法（Consensus Algorithm）
* 以太坊客户端（Client）
  * Go-Ethereum（Geth）
  * Parity



**DAPP与智能合约的区别**

DApp是多个智能合约+一个web用户界面（类似于现在的APP）；

DApp还可以包含以下组件：

* 去中心化存储协议和平台
* 去中心化消息传递协议和平台

而智能合约只是一个函数。



**如何搭建智能合约的开发环境？**

无需搭建，可使用在线的IDE（Remix），里面包含Solidity编译器（https://remix.ethereum.org/）



**智能合约的开发流程？**

合约的创建

1. 在IDE Remix上编写智能合约代码，编译成字节码
2. 选择以太坊区块链，并在上面登记合约
   * Ropsten测试网（用于测试的区块链）
3. 创建合约需要消耗一定的Gas
4. 创建成功，获得合约的地址



合约的调用

1. 到ropsten.etherscan.io区块浏览器中，通过合约的地址，查看合约详情（余额、有过哪些交易）
2. 在IDE Remix中点击“Run”选项卡，查看已编译好的智能合约
3. 输入入参，并点击具体函数名对应的按钮，提交交易
4. 交易被发送到合约账户，合约账户接收到请求，将交易作为入参，交由EVM执行合约中的代码



**有哪些以太坊常用的钱包**

* MetaMask（浏览器钱包）
* Jaxx（端上的钱包，支持android、ios、windows、mac、linux）





**什么是公链、侧链、联盟链、互联链、基础链、行业链、测试链？**

按网络范围：公链、私链、联盟链

按部署环境：主链、测试链

按对接类型：单链、侧链、互联链

按应用范围：基础链、行业链



| 名称   | 类型       | 特点                                                         | 主流项目                                                     | 描述                                                         |
| ------ | ---------- | ------------------------------------------------------------ | ------------------------------------------------------------ | ------------------------------------------------------------ |
| 公链   | 按网络范围 | 任何人都可在其上作交易；<br />任何人都可参与其共识过程（挖矿、记账）；<br />数据完全公开透明； | 比特币【BTC】、以太坊【ETH】、波卡【DOT】、EOS、币安、索拉纳 | 数据完全公开；<br />处理速度慢（比特币：每秒7笔左右；以太坊：每秒15笔左右）；<br />完全去中心化系统； |
| 私链   | 按网络范围 | 仅组织内部的成员可以在其上交易、参与共识过程、查看数据       |                                                              | 处理速度快、数据安全、交易成本低；<br />实质是中心化系统；   |
| 联盟链 | 按网络范围 | 参与者需要被提前筛选出或直接指定；<br />会被限制拥有交易、参与共识过程、查看数据这些权限 |                                                              | 可将部分数据公开；<br />部分去中心化；                       |



